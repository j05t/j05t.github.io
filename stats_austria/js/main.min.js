var municipalityGeofeatures,districtGeofeatures,stateGeofeatures,bubblesDomainPopulation=[0,3e5],bubblesDomainCases=[0,1e3],oldYear=2002;effectController={colorUrbanity:!1,colorPopulation:!1,showPopulation:!1,showCases:!1,colorScale:void 0,data:urbanity,granularity:"Gemeinde",causesOfDeath:"B\xF6sartige Neubildungen",year:2002,domainMin:0,domainMax:1e3,animate:!1,loop:!0,causes:new Map};var populationColorScale=d3.scale.log().domain([200,2e5]).range(["#deebf7","#08306b","#08306b"]),urbanityColorRange=["#8e0152","#c51b7d","#de77ae","#f1b62c","#fddf17","#f7ef58","#e4f541","#b8e186","#7fbc41","#4d9221","#276419"],urbanityColorScale=d3.scale.ordinal().domain([101,102,103,210,220,310,320,330,410,420,430]).range(urbanityColorRange),deathsColorRange=["#fff5f0","#aa1017","#a91016","#a71016","#a60f16","#a40f16","#a30e15","#a10e15","#67000d"],deathsColorScale=d3.scale.linear().domain([0,900]).range(deathsColorRange),width=window.innerWidth-20,height=window.innerHeight-20,projection=d3.geo.mercator().scale(5706.315012582816).center([13.346443836054394,47.72342963833456]).translate([width/2,height/2]),path=d3.geo.path().projection(projection),svg=d3.select("body").append("svg").attr("width",width).attr("height",height),municipalities=svg.append("g").attr("class","municipalities"),districts=svg.append("g").attr("class","districts"),bubbles=svg.append("g").attr("class","bubbles");svg.append("g").attr("class","legendLinear").attr("transform","translate(10,140)");var legendLinear=d3.legend.color().labelFormat(d3.format(".0f")).shapeWidth(30).cells(10).title(effectController.causesOfDeath+", Inzidenz pro 100.000 Einwohner").orient("horizontal").scale(deathsColorScale);svg.select(".legendLinear").call(legendLinear);var updateLegend=function(){legendLinear=d3.legend.color().labelFormat(d3.format(".0f")).shapeWidth(30).cells(10).title(effectController.causesOfDeath+", Inzidenz pro 100.000 Einwohner").orient("horizontal").scale(deathsColorScale),svg.select(".legendLinear").call(legendLinear)},updateBubblesLegend=function(a){if(bubblesLegend.selectAll("*").remove(),effectController.showPopulation||effectController.showCases){var b=d3.scale.sqrt().domain(a).range([0,24]);bubblesLegend.selectAll("legend").data(a).enter().append("circle").attr("fill","none").attr("stroke","#ccc").attr("cy",a=>-b(a)).attr("r",b),bubblesLegend.selectAll("legend").data(a).enter().append("text").data(a).attr("y",a=>-2*b(a)).attr("dy","1.3em").text(d3.format(".1s"))}},zoom=d3.behavior.zoom().scaleExtent([1,1/0]).on("zoom",zoomed);svg.call(zoom);var bubblesLegend=svg.append("g").attr("fill","#777").attr("transform",`translate(${width-50},${height-2})`).attr("text-anchor","middle").attr("class","bubblesLegend").style("font","10px sans-serif"),gui=new dat.GUI,f1=gui.addFolder("Coloring"),onColorUrbanityController=f1.add(effectController,"colorUrbanity"),onColorPopulationController=f1.add(effectController,"colorPopulation");f1.open();var f2=gui.addFolder("Detailed Information"),f3=gui.addFolder("Animation");f3.open();var onYearChangeController=f3.add(effectController,"year",2002,2017).step(1).listen(),onAnimateController=f3.add(effectController,"animate");f3.add(effectController,"loop");var onShowPopulationController=f2.add(effectController,"showPopulation"),onShowCasesController=f2.add(effectController,"showCases"),onGranularityChangeController=f1.add(effectController,"granularity",["Gemeinde","Bundesland"]).listen(),onShowCausesOfDeathController=f1.add(effectController,"causesOfDeath",causesOfDeathGroups),onDomainMinChangeController=f1.add(effectController,"domainMin",0,500).step(1).listen(),onDomainMaxChangeController=f1.add(effectController,"domainMax",0,1e3).step(1).listen(),animate=function(){effectController.loop&&2017<=effectController.year&&(effectController.year=2002),effectController.animate&&2017>effectController.year?requestAnimationFrame(animate,500):onAnimateController.setValue(!1),effectController.year+=.1,Math.floor(effectController.year)!==oldYear&&(oldYear=effectController.year,updateColor()),effectController.showPopulation?updateBubbles(population,bubblesDomainPopulation):effectController.showCases&&updateBubbles(effectController.causes[effectController.causesOfDeath],bubblesDomainCases)};let getData=function(a){let b=Math.round(effectController.year);return effectController.causes[effectController.causesOfDeath][a.properties.iso][Math.floor(b)]},getIncidence=function(a){let b=Math.round(effectController.year),c=population[a.properties.iso][b],d=effectController.causes[effectController.causesOfDeath][a.properties.iso][Math.floor(b)];return Math.round(1e5*d/c)},updateDistricts=function(a){0===districts.selectAll("path")[0].length?districts.selectAll("path").data(a).enter().append("path").attr("d",path).attr("fill",a=>deathsColorScale(getIncidence(a))).on("click",clicked).on("mouseover",function(a){return createChart(a),tooltip.style("visibility","visible")}).on("mousemove",function(){return tooltip.style("top",d3.event.pageY+10+"px").style("left",d3.event.pageX+15+"px")}).on("mouseout",function(){return tooltip.style("visibility","hidden")}):districts.selectAll("path").data(a).attr("fill",a=>deathsColorScale(getIncidence(a))).on("click",clicked).on("mouseover",function(a){return createChart(a),tooltip.style("visibility","visible")}).on("mousemove",function(){return tooltip.style("top",d3.event.pageY+10+"px").style("left",d3.event.pageX+15+"px")}).on("mouseout",function(){return tooltip.style("visibility","hidden")})};var updateColor=function(){municipalities.selectAll("path").data(municipalityGeofeatures).attr("fill",a=>deathsColorScale(getIncidence(a))).select("title").text(a=>a.properties.name+": "+population[a.properties.iso][Math.floor(effectController.year)]+" Einwohner\n"+getData(a)+" F\xE4lle, Inzidenz "+getIncidence(a)),effectController.showPopulation?updateBubbles(population,bubblesDomainPopulation):effectController.showCases&&updateBubbles(effectController.causes[effectController.causesOfDeath],bubblesDomainCases),"Bundesland"===effectController.granularity?updateDistricts(stateGeofeatures):"Bezirk"===effectController.granularity&&updateDistricts(districtGeofeatures)};onDomainMinChangeController.onChange(function(a){deathsColorScale=d3.scale.linear().domain([a,effectController.domainMax]).range(deathsColorRange),updateLegend(),updateColor()}),onDomainMaxChangeController.onChange(function(a){deathsColorScale=d3.scale.linear().domain([effectController.domainMin,a]).range(deathsColorRange),updateLegend(),updateColor()}),onAnimateController.onChange(function(a){a?animate():effectController.animate=!1}),onYearChangeController.onChange(function(a){a&&(effectController.year=a,effectController.colorUrbanity?onColorUrbanityController.setValue(!1):effectController.colorPopulation&&onColorPopulationController.setValue(!1),updateColor())}),onGranularityChangeController.onChange(function(a){a&&(districts.selectAll("*").remove(),"Bezirk"===a?showDistricts():"Bundesland"===a?showStates():updateDomain())});var updateDomain=function(a){if(console.log("update domain"),a=a||effectController.causesOfDeath,"Gemeinde"===effectController.granularity)return onDomainMinChangeController.setValue(0),void onDomainMaxChangeController.setValue(1e3);let b,c;a===causesOfDeathGroups[0]?(b=180,c=290):a===causesOfDeathGroups[1]?(b=270,c=550):a===causesOfDeathGroups[2]?(b=30,c=75):a===causesOfDeathGroups[3]?(b=20,c=60):a===causesOfDeathGroups[4]?(b=80,c=240):a===causesOfDeathGroups[5]?(b=35,c=70):void 0,onDomainMinChangeController.setValue(b),onDomainMaxChangeController.setValue(c)},showCauses=function(a){return a in effectController.causes?(console.log(a+" already loaded"),updateColor(),void updateDomain(a)):void(console.log("loading data for "+a),d3.json("data/"+a+".json",function(b,c){return b?console.log(b):void(effectController.causes[a]=c,updateColor(),updateDomain(a))}))};onShowCausesOfDeathController.onChange(function(a){a&&showCauses(a)});var clearColor=function(){municipalities.selectAll("path").data(municipalityGeofeatures).attr("fill","#cfcfcf")};onColorUrbanityController.onChange(function(a){a?(onColorPopulationController.setValue(!1),municipalities.selectAll("path").data(municipalityGeofeatures).attr("fill",a=>urbanityColorScale(urbanity.get(a.properties.iso))).select("title").text(a=>a.properties.name+": "+urbanityCodeNames.get(urbanity.get(a.properties.iso)))):!1===effectController.colorPopulation&&(clearColor(),updateColor())}),onColorPopulationController.onChange(function(a){a?(onColorUrbanityController.setValue(!1),municipalities.selectAll("path").data(municipalityGeofeatures).attr("fill",a=>populationColorScale(population[a.properties.iso][Math.floor(effectController.year)])).select("title").text(a=>a.properties.name+": "+population[a.properties.iso][Math.floor(effectController.year)]+" Einwohner")):!1===effectController.colorPopulation&&(clearColor(),updateColor())});var updateBubbles=function(a,b){let c=Math.round(effectController.year),e=d3.scale.sqrt().domain(b).range([0,24]),f=effectController.showPopulation?" Einwohner":" F\xE4lle";bubbles.selectAll("circle").data(municipalityGeofeatures).attr("r",b=>e(a[b.properties.iso][Math.floor(c)])).select("title").text(b=>b.properties.name+": "+a[b.properties.iso][Math.floor(c)]+f)};onShowPopulationController.onChange(function(a){a?(onShowCasesController.setValue(!1),updateBubbles(population,bubblesDomainPopulation)):!effectController.showCases&&bubbles.selectAll("circle").attr("r",0),updateBubblesLegend(bubblesDomainPopulation)}),onShowCasesController.onChange(function(a){a?(onShowPopulationController.setValue(!1),updateBubbles(effectController.causes[effectController.causesOfDeath],bubblesDomainCases)):!effectController.showPopulation&&bubbles.selectAll("circle").attr("r",0),updateBubblesLegend(bubblesDomainCases)}),d3.json("data/gemeinden_wien_bezirke_topo.json",function(a,b){return a?console.log(a):void(municipalityGeofeatures=topojson.feature(b,b.objects.gemeinden_wien_bezirke).features,municipalities.selectAll("path").data(municipalityGeofeatures).enter().append("path").attr("d",path).attr("fill","#cfcfcf").on("click",clicked).append("title").text(a=>a.properties.name+": "+urbanityCodeNames.get(effectController.data.get(a.properties.iso))),updateBubblesLegend(),bubbles.selectAll("bubbles").data(municipalityGeofeatures).enter().append("circle").attr("fill","brown").attr("fill-opacity",.8).attr("stroke","#fff").attr("stroke-width",.5).attr("transform",a=>`translate(${path.centroid(a)})`).attr("r",0).append("title").text(""),showCauses(effectController.causesOfDeath),onGranularityChangeController.setValue("Bundesland"))});var showDistricts=function(){"undefined"==typeof districtGeofeatures&&d3.json("data/bezirke_999_topo.json",function(a,b){return a?console.log(a):void(districtGeofeatures=topojson.feature(b,b.objects.bezirke).features,districts.selectAll("path").data(districtGeofeatures).enter().append("path").attr("d",path).on("click",clicked))})},tooltip=d3.select("body").append("div").attr("id","tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff"),createChart=function(a){tooltip.selectAll("*").remove();let b=effectController.causes[effectController.causesOfDeath][a.properties.iso],c=[];for(let d=2002;2017>=d;d++)c.push([d,b[d]]);let d={top:5,right:10,bottom:20,left:35},e=240-d.left-d.right,f=150-d.top-d.bottom,g=d3.time.scale().range([0,e]),h=d3.scale.linear().range([f,0]);var i=d3.svg.axis().scale(g).orient("bottom");let j=d3.svg.axis().scale(h).orient("left"),k=d3.svg.line().x(function(a){return g(a.year)}).y(function(a){return h(a.incidence)});tooltip.append("p").text(a.properties.name);let l=tooltip.append("svg").attr("width",e+d.left+d.right).attr("height",f+d.top+d.bottom).append("g").attr("transform","translate("+d.left+","+d.top+")"),m=function(b,c){let d=population[a.properties.iso][b];return Math.round(1e5*c/d)},n=c.map(function(a){return{year:a[0],cases:a[1],incidence:m(a[0],a[1])}});g.domain(d3.extent(n,function(a){return a.year})),h.domain(d3.extent(n,function(a){return a.incidence})),l.append("g").attr("class","x axis").attr("transform","translate(0,"+f+")").call(i),l.append("g").attr("class","y axis").call(j).append("text").attr("transform","rotate(-90)").attr("y",2).attr("dy",".71em").style("text-anchor","end").text("Inzidenz / 100.000"),l.append("path").datum(n).attr("class","line").attr("d",k);let o=Math.floor(effectController.year),p=m(o,b[o]);l.append("circle").attr("fill","red").attr("r",3).attr("cx",g(o)).attr("cy",h(p))},showStates=function(){"undefined"==typeof stateGeofeatures?d3.json("data/laender_999_topo.json",function(a,b){return a?console.log(a):void(stateGeofeatures=topojson.feature(b,b.objects.laender).features,updateDomain(),updateDistricts(stateGeofeatures))}):(updateDomain(),updateDistricts(stateGeofeatures))},clicked=function(a,b){console.log(a.properties.name,a.properties.iso),console.log("index: "+b)};function zoomed(){municipalities.attr("transform","translate("+zoom.translate()+")scale("+zoom.scale()+")").selectAll("path").style("stroke-width",1/zoom.scale()+"px"),districts.attr("transform","translate("+zoom.translate()+")scale("+zoom.scale()+")").selectAll("path").style("stroke-width",1/zoom.scale()+"px"),bubbles.attr("transform","translate("+zoom.translate()+")scale("+zoom.scale()+")").selectAll("path").style("stroke-width",1/zoom.scale()+"px")}